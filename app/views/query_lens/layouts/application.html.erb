<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QueryLens</title>
  <%= csrf_meta_tags %>
  <style>
    /* ── Reset & Base ── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0f0f12;
      color: #e4e4e7;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }
    button { cursor: pointer; font-family: inherit; }
    input, textarea, button { font-size: inherit; }

    /* ── Layout ── */
    .ql-app { display: flex; flex-direction: column; height: 100vh; }
    .ql-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 56px; flex-shrink: 0;
      background: #18181b; border-bottom: 1px solid #27272a;
    }
    .ql-header-left { display: flex; align-items: center; gap: 12px; }
    .ql-logo {
      font-size: 16px; font-weight: 700; color: #fff;
      letter-spacing: -0.02em;
    }
    .ql-logo-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 28px; height: 28px; border-radius: 8px;
      background: linear-gradient(135deg, #818cf8 0%, #6366f1 50%, #4f46e5 100%);
      margin-right: 10px; vertical-align: middle;
    }
    .ql-logo-icon svg { width: 16px; height: 16px; }
    .ql-badge {
      font-size: 11px; font-weight: 500; color: #a1a1aa;
      background: #27272a; padding: 2px 10px; border-radius: 100px;
      letter-spacing: 0.02em;
    }
    .ql-status { font-size: 13px; color: #71717a; display: flex; align-items: center; gap: 8px; }

    .ql-main { display: flex; flex: 1; min-height: 0; }

    /* ── Left Panel: Chat ── */
    .ql-chat {
      width: 420px; min-width: 360px; display: flex; flex-direction: column;
      background: #18181b; border-right: 1px solid #27272a;
    }
    .ql-chat-content {
      display: flex; flex-direction: column; flex: 1; min-height: 0;
    }
    .ql-tab-bar {
      display: flex; border-bottom: 1px solid #27272a; flex-shrink: 0;
    }
    .ql-tab {
      flex: 1; padding: 12px 16px; background: none; border: none;
      font-size: 12px; font-weight: 600; color: #52525b;
      text-transform: uppercase; letter-spacing: 0.06em;
      border-bottom: 2px solid transparent; transition: all 0.15s;
      cursor: pointer;
    }
    .ql-tab:hover { color: #a1a1aa; }
    .ql-tab-active { color: #818cf8; border-bottom-color: #6366f1; }

    /* ── Conversation History ── */
    .ql-conversation-history {
      border-bottom: 1px solid #27272a; flex-shrink: 0;
    }
    .ql-new-chat-btn {
      display: flex; align-items: center; gap: 8px; width: 100%;
      padding: 10px 16px; background: none; border: none;
      color: #818cf8; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: background 0.15s;
    }
    .ql-new-chat-btn:hover { background: rgba(99,102,241,0.08); }
    .ql-new-chat-btn svg { width: 16px; height: 16px; }
    .ql-conversation-list {
      max-height: 200px; overflow-y: auto;
    }
    .ql-conversation-list::-webkit-scrollbar { width: 6px; }
    .ql-conversation-list::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    .ql-conversation-divider {
      padding: 4px 16px 6px; font-size: 10px; font-weight: 600; color: #52525b;
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .ql-conversation-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px; cursor: pointer; transition: background 0.15s;
      font-size: 13px; color: #a1a1aa; border-left: 3px solid transparent;
    }
    .ql-conversation-item:hover { background: rgba(99,102,241,0.06); }
    .ql-conversation-item-active {
      border-left-color: #6366f1; background: rgba(99,102,241,0.08); color: #e4e4e7;
    }
    .ql-conversation-title {
      flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .ql-conversation-time {
      font-size: 11px; color: #52525b; flex-shrink: 0;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }
    .ql-conversation-delete {
      background: none; border: none; color: #52525b; font-size: 16px;
      padding: 0 4px; cursor: pointer; line-height: 1;
      opacity: 0; transition: opacity 0.15s, color 0.15s;
    }
    .ql-conversation-item:hover .ql-conversation-delete { opacity: 1; }
    .ql-conversation-delete:hover { color: #ef4444; }

    /* ── Saved Queries Panel ── */
    .ql-saved-panel {
      flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;
    }
    .ql-saved-toolbar {
      display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid #27272a; flex-shrink: 0;
    }
    .ql-saved-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: #27272a; color: #a1a1aa; border: 1px solid #3f3f46; border-radius: 8px;
      padding: 6px 12px; font-size: 12px; font-weight: 500;
      transition: all 0.15s;
    }
    .ql-saved-btn:hover { background: #3f3f46; color: #e4e4e7; }
    .ql-saved-btn svg { width: 14px; height: 14px; }
    .ql-saved-btn-primary { background: #4f46e5; color: #fff; border-color: #6366f1; }
    .ql-saved-btn-primary:hover { background: #4338ca; color: #fff; }
    .ql-saved-list { flex: 1; overflow-y: auto; padding: 8px 0; }
    .ql-saved-list::-webkit-scrollbar { width: 6px; }
    .ql-saved-list::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    .ql-saved-empty {
      padding: 40px 20px; text-align: center; color: #52525b; font-size: 13px; line-height: 1.5;
    }
    .ql-saved-project { margin-bottom: 2px; }
    .ql-saved-project-header {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px; cursor: pointer; transition: background 0.15s;
      font-size: 13px; font-weight: 600; color: #d4d4d8;
    }
    .ql-saved-project-header:hover { background: rgba(99,102,241,0.06); }
    .ql-saved-chevron {
      width: 14px; height: 14px; color: #52525b; flex-shrink: 0;
      transition: transform 0.2s; transform: rotate(-90deg);
    }
    .ql-saved-chevron.ql-open { transform: rotate(0deg); }
    .ql-saved-folder { width: 16px; height: 16px; color: #818cf8; flex-shrink: 0; }
    .ql-saved-project-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .ql-saved-count {
      font-size: 11px; color: #52525b; background: #27272a; padding: 1px 6px;
      border-radius: 10px; font-weight: 500;
    }
    .ql-saved-unorg { padding-left: 38px; }
    .ql-saved-query {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 16px 7px 46px; cursor: pointer; transition: background 0.15s;
    }
    .ql-saved-query:hover { background: rgba(99,102,241,0.06); }
    .ql-saved-query-icon { width: 14px; height: 14px; color: #52525b; flex-shrink: 0; }
    .ql-saved-query-info { flex: 1; min-width: 0; }
    .ql-saved-query-name {
      font-size: 13px; color: #a1a1aa; overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }
    .ql-saved-query-desc {
      font-size: 11px; color: #52525b; overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap; margin-top: 1px;
    }
    .ql-kebab {
      background: none; border: none; color: #52525b; font-size: 16px;
      padding: 2px 6px; border-radius: 4px; line-height: 1;
      opacity: 0; transition: opacity 0.15s;
    }
    .ql-saved-project-header:hover .ql-kebab,
    .ql-saved-query:hover .ql-kebab { opacity: 1; }
    .ql-kebab:hover { background: #3f3f46; color: #e4e4e7; }
    .ql-kebab-menu {
      margin: 0 16px 4px 46px; background: #27272a; border: 1px solid #3f3f46;
      border-radius: 8px; overflow: hidden; animation: ql-fadeIn 0.15s ease-out;
    }
    .ql-kebab-menu button {
      display: block; width: 100%; padding: 8px 14px; background: none; border: none;
      color: #a1a1aa; font-size: 12px; text-align: left; cursor: pointer;
      transition: background 0.1s;
    }
    .ql-kebab-menu button:hover { background: #3f3f46; color: #e4e4e7; }

    /* ── Save Modal ── */
    .ql-modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
      display: flex; align-items: center; justify-content: center;
      animation: ql-fadeIn 0.15s ease-out;
    }
    .ql-modal {
      background: #1c1c21; border: 1px solid #27272a; border-radius: 16px;
      padding: 24px; width: 400px; max-width: 90vw;
    }
    .ql-modal-title {
      font-size: 15px; font-weight: 600; color: #e4e4e7; margin-bottom: 16px;
    }
    .ql-modal-label {
      display: block; font-size: 12px; font-weight: 500; color: #71717a;
      margin-bottom: 4px; margin-top: 12px;
    }
    .ql-modal-label:first-of-type { margin-top: 0; }
    .ql-modal-input {
      width: 100%; padding: 8px 12px; background: #0f0f12; border: 1px solid #3f3f46;
      border-radius: 8px; color: #e4e4e7; font-size: 13px; outline: none;
      transition: border-color 0.15s;
    }
    .ql-modal-input:focus { border-color: #6366f1; }
    select.ql-modal-input { cursor: pointer; }
    .ql-modal-actions {
      display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;
    }
    .ql-modal-btn {
      padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500;
      border: none; cursor: pointer; transition: all 0.15s;
    }
    .ql-modal-btn-cancel { background: #27272a; color: #a1a1aa; }
    .ql-modal-btn-cancel:hover { background: #3f3f46; }
    .ql-modal-btn-save { background: #6366f1; color: #fff; }
    .ql-modal-btn-save:hover { background: #4f46e5; }
    .ql-messages {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .ql-messages::-webkit-scrollbar { width: 6px; }
    .ql-messages::-webkit-scrollbar-track { background: transparent; }
    .ql-messages::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

    .ql-empty-state {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 16px; padding: 40px;
    }
    .ql-empty-icon {
      width: 56px; height: 56px; border-radius: 16px;
      background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%);
      display: flex; align-items: center; justify-content: center;
    }
    .ql-empty-icon svg { width: 28px; height: 28px; color: #818cf8; }
    .ql-empty-title { font-size: 15px; font-weight: 600; color: #d4d4d8; }
    .ql-empty-text { font-size: 13px; color: #71717a; text-align: center; line-height: 1.5; }

    .ql-msg { display: flex; gap: 10px; animation: ql-fadeIn 0.25s ease-out; }
    .ql-msg-user { flex-direction: row-reverse; }
    .ql-msg-avatar {
      width: 30px; height: 30px; border-radius: 10px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 600;
    }
    .ql-msg-user .ql-msg-avatar { background: #3730a3; color: #c7d2fe; }
    .ql-msg-ai .ql-msg-avatar {
      background: linear-gradient(135deg, #818cf8, #6366f1);
      color: #fff;
    }
    .ql-msg-bubble {
      padding: 10px 14px; border-radius: 14px; max-width: 85%;
      font-size: 13.5px; line-height: 1.55; word-wrap: break-word;
    }
    .ql-msg-user .ql-msg-bubble {
      background: #312e81; color: #e0e7ff; border-bottom-right-radius: 4px;
    }
    .ql-msg-ai .ql-msg-bubble {
      background: #27272a; color: #d4d4d8; border-bottom-left-radius: 4px;
    }
    .ql-msg-error .ql-msg-bubble {
      background: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d;
      border-bottom-left-radius: 4px;
    }
    .ql-msg-error .ql-msg-avatar { background: #7f1d1d; color: #fca5a5; }

    .ql-typing {
      display: flex; gap: 5px; padding: 4px 0;
    }
    .ql-typing span {
      width: 7px; height: 7px; border-radius: 50%; background: #52525b;
      animation: ql-bounce 1.4s ease-in-out infinite;
    }
    .ql-typing span:nth-child(2) { animation-delay: 0.16s; }
    .ql-typing span:nth-child(3) { animation-delay: 0.32s; }

    .ql-input-area {
      padding: 16px 20px; border-top: 1px solid #27272a;
    }
    .ql-input-form {
      display: flex; gap: 8px; align-items: center;
      background: #27272a; border-radius: 14px; padding: 6px 6px 6px 16px;
      border: 1px solid #3f3f46; transition: border-color 0.15s;
    }
    .ql-input-form:focus-within { border-color: #6366f1; }
    .ql-input-form input {
      flex: 1; background: transparent; border: none; outline: none;
      color: #e4e4e7; font-size: 14px; padding: 6px 0;
    }
    .ql-input-form input::placeholder { color: #52525b; }
    .ql-input-form button {
      background: #6366f1; color: #fff; border: none; border-radius: 10px;
      padding: 8px 16px; font-size: 13px; font-weight: 600;
      transition: all 0.15s;
    }
    .ql-input-form button:hover { background: #4f46e5; }
    .ql-input-form button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ── Right Panel ── */
    .ql-workspace { flex: 1; display: flex; flex-direction: column; min-width: 0; }

    /* ── SQL Editor ── */
    .ql-editor-section {
      flex-shrink: 0; display: flex; flex-direction: column;
      border-bottom: 1px solid #27272a;
    }
    .ql-editor-toolbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; border-bottom: 1px solid #27272a;
    }
    .ql-editor-title {
      font-size: 12px; font-weight: 600; color: #71717a;
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .ql-run-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: #059669; color: #fff; border: none; border-radius: 8px;
      padding: 7px 14px; font-size: 12px; font-weight: 600;
      transition: all 0.15s; letter-spacing: 0.01em;
    }
    .ql-run-btn:hover { background: #047857; }
    .ql-run-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .ql-run-btn svg { width: 14px; height: 14px; }
    .ql-run-shortcut {
      font-size: 10px; color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.15); padding: 2px 6px;
      border-radius: 4px; margin-left: 4px;
    }
    .ql-editor-wrap { padding: 12px 20px 16px; }
    .ql-sql-textarea {
      width: 100%; min-height: 140px; max-height: 300px; resize: vertical;
      background: #0c0c0f; color: #a5f3fc; border: 1px solid #27272a;
      border-radius: 12px; padding: 16px; font-size: 13px; line-height: 1.6;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', 'Consolas', monospace;
      outline: none; tab-size: 2; transition: border-color 0.15s;
    }
    .ql-sql-textarea:focus { border-color: #3f3f46; }
    .ql-sql-textarea::placeholder { color: #3f3f46; }

    /* ── Results ── */
    .ql-results-section { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .ql-results-toolbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; border-bottom: 1px solid #27272a; flex-shrink: 0;
    }
    .ql-results-title {
      font-size: 12px; font-weight: 600; color: #71717a;
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .ql-row-count {
      font-size: 12px; color: #52525b; font-variant-numeric: tabular-nums;
    }
    .ql-results-body {
      flex: 1; overflow: auto; padding: 0;
    }
    .ql-results-body::-webkit-scrollbar { width: 6px; height: 6px; }
    .ql-results-body::-webkit-scrollbar-track { background: transparent; }
    .ql-results-body::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

    .ql-results-empty {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 100%; gap: 12px; color: #52525b;
    }
    .ql-results-empty svg { width: 40px; height: 40px; color: #3f3f46; }
    .ql-results-empty span { font-size: 13px; }

    /* ── Table ── */
    .ql-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .ql-table th {
      position: sticky; top: 0; z-index: 2;
      background: #1c1c21; color: #a1a1aa; font-weight: 600;
      text-align: left; padding: 10px 16px; font-size: 11px;
      text-transform: uppercase; letter-spacing: 0.05em;
      border-bottom: 1px solid #27272a; white-space: nowrap;
    }
    .ql-table td {
      padding: 9px 16px; color: #d4d4d8; white-space: nowrap;
      border-bottom: 1px solid rgba(39,39,42,0.5);
      font-variant-numeric: tabular-nums;
    }
    .ql-table tr:hover td { background: rgba(99,102,241,0.04); }
    .ql-table .ql-null { color: #52525b; font-style: italic; font-size: 11px; }

    .ql-truncated {
      padding: 8px 20px; font-size: 12px; color: #d97706;
      background: rgba(217,119,6,0.08); border-bottom: 1px solid #27272a;
    }

    .ql-error-box {
      margin: 20px; padding: 14px 18px; border-radius: 10px;
      background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
      color: #fca5a5; font-size: 13px; line-height: 1.5;
    }

    /* ── Spinner ── */
    .ql-spinner {
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid #3f3f46; border-top-color: #818cf8;
      animation: ql-spin 0.7s linear infinite; display: inline-block;
    }
    .ql-spinner-sm { width: 14px; height: 14px; }
    .ql-loading-row {
      display: flex; align-items: center; justify-content: center;
      gap: 10px; padding: 40px; color: #71717a; font-size: 13px;
    }

    /* ── Activity Trace ── */
    .ql-trace {
      margin: 4px 0 4px 40px; padding: 0;
      animation: ql-fadeIn 0.25s ease-out;
    }
    .ql-trace-inner {
      background: rgba(99,102,241,0.06); border: 1px solid rgba(99,102,241,0.12);
      border-radius: 10px; padding: 10px 14px; font-size: 12px;
    }
    .ql-trace-header {
      display: flex; align-items: center; gap: 6px;
      color: #71717a; font-size: 11px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    .ql-trace-header svg { width: 12px; height: 12px; color: #6366f1; }
    .ql-trace-row {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 3px 0; color: #a1a1aa; font-size: 12px; line-height: 1.4;
    }
    .ql-trace-time {
      color: #52525b; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 11px; flex-shrink: 0; min-width: 62px;
    }
    .ql-trace-dot {
      width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
      margin-top: 5px;
    }
    .ql-trace-dot-blue { background: #6366f1; }
    .ql-trace-dot-green { background: #059669; }
    .ql-trace-dot-amber { background: #d97706; }
    .ql-trace-dot-red { background: #ef4444; }
    .ql-trace-label { color: #a1a1aa; }
    .ql-trace-label strong { color: #d4d4d8; font-weight: 500; }
    .ql-trace-tables {
      display: inline-flex; flex-wrap: wrap; gap: 4px; margin-top: 2px;
    }
    .ql-trace-table-tag {
      display: inline-block; padding: 1px 6px; border-radius: 4px;
      background: rgba(99,102,241,0.1); color: #818cf8;
      font-size: 10px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    /* ── Message timestamps ── */
    .ql-msg-time {
      font-size: 10px; color: #52525b; margin-top: 4px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    /* ── Restricted Tables Banner ── */
    .ql-restricted-banner {
      border-bottom: 1px solid #27272a;
    }
    .ql-restricted-toggle {
      display: flex; align-items: center; gap: 8px; width: 100%;
      padding: 10px 20px; background: rgba(234,179,8,0.05); border: none;
      color: #a1a1aa; font-size: 12px; cursor: pointer;
      transition: background 0.15s;
    }
    .ql-restricted-toggle:hover { background: rgba(234,179,8,0.1); }
    .ql-restricted-toggle svg { width: 14px; height: 14px; color: #ca8a04; flex-shrink: 0; }
    .ql-restricted-chevron {
      margin-left: auto; transition: transform 0.2s;
    }
    .ql-restricted-chevron.ql-open { transform: rotate(180deg); }
    .ql-restricted-list {
      padding: 8px 20px 12px; display: flex; flex-wrap: wrap; gap: 6px;
    }
    .ql-restricted-tag {
      display: inline-block; padding: 3px 10px; border-radius: 6px;
      background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.2);
      color: #ca8a04; font-size: 11px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    /* ── Animations ── */
    @keyframes ql-spin { to { transform: rotate(360deg); } }
    @keyframes ql-fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes ql-bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
  <%= yield %>
</body>
</html>
