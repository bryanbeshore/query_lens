<div id="query-lens-app"
     data-execute-url="<%= query_lens.execute_path %>"
     data-generate-url="<%= query_lens.generate_path %>"
     class="ql-app">

  <!-- Header -->
  <header class="ql-header">
    <div class="ql-header-left">
      <h1 class="ql-logo">
        <span class="ql-logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
          </svg>
        </span>QueryLens
      </h1>
      <span class="ql-badge">AI-powered SQL</span>
    </div>
    <div class="ql-status" id="ql-status"></div>
  </header>

  <!-- Main -->
  <div class="ql-main">

    <!-- Chat Panel -->
    <div class="ql-chat">
      <div class="ql-chat-header">Conversation</div>
      <div class="ql-messages" id="ql-messages">
        <div class="ql-empty-state" id="ql-empty-state">
          <div class="ql-empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
            </svg>
          </div>
          <div class="ql-empty-title">Ask about your data</div>
          <div class="ql-empty-text">
            Try something like:<br>
            "How many users signed up this month?"<br>
            "What's the total revenue by plan?"
          </div>
        </div>
      </div>
      <div class="ql-input-area">
        <form class="ql-input-form" id="ql-form">
          <input type="text" id="ql-input" placeholder="Ask a question about your data..." autocomplete="off">
          <button type="submit" id="ql-ask-btn">Ask</button>
        </form>
      </div>
    </div>

    <!-- Workspace -->
    <div class="ql-workspace">

      <!-- SQL Editor -->
      <div class="ql-editor-section">
        <div class="ql-editor-toolbar">
          <div class="ql-editor-title">SQL Editor</div>
          <button class="ql-run-btn" id="ql-run-btn">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            Run
            <span class="ql-run-shortcut">&hairsp;&#8984;&#9166;&hairsp;</span>
          </button>
        </div>
        <div class="ql-editor-wrap">
          <textarea class="ql-sql-textarea" id="ql-sql" placeholder="-- Your SQL query will appear here..." spellcheck="false"></textarea>
        </div>
      </div>

      <!-- Results -->
      <div class="ql-results-section">
        <div class="ql-results-toolbar">
          <div class="ql-results-title">Results</div>
          <div class="ql-row-count" id="ql-row-count"></div>
        </div>
        <div class="ql-results-body" id="ql-results">
          <div class="ql-results-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 0v.375"/>
            </svg>
            <span>Run a query to see results</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const app = document.getElementById('query-lens-app');
  const executeUrl = app.dataset.executeUrl;
  const generateUrl = app.dataset.generateUrl;

  const el = {
    messages:  document.getElementById('ql-messages'),
    emptyState: document.getElementById('ql-empty-state'),
    input:     document.getElementById('ql-input'),
    form:      document.getElementById('ql-form'),
    askBtn:    document.getElementById('ql-ask-btn'),
    sql:       document.getElementById('ql-sql'),
    runBtn:    document.getElementById('ql-run-btn'),
    results:   document.getElementById('ql-results'),
    rowCount:  document.getElementById('ql-row-count'),
    status:    document.getElementById('ql-status'),
  };

  let conversation = [];

  // ── Events ──
  el.form.addEventListener('submit', (e) => { e.preventDefault(); ask(); });
  el.runBtn.addEventListener('click', () => runQuery());
  el.sql.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); runQuery(); }
    // Tab inserts spaces
    if (e.key === 'Tab') {
      e.preventDefault();
      const s = el.sql.selectionStart;
      el.sql.value = el.sql.value.substring(0, s) + '  ' + el.sql.value.substring(el.sql.selectionEnd);
      el.sql.selectionStart = el.sql.selectionEnd = s + 2;
    }
  });

  // ── Ask ──
  async function ask() {
    const q = el.input.value.trim();
    if (!q) return;

    el.input.value = '';
    addMessage('user', q);
    conversation.push({ role: 'user', content: q });
    setLoading(true);

    try {
      const data = await post(generateUrl, { messages: conversation });

      if (data.error) { addMessage('error', data.error); return; }
      if (data.explanation) addMessage('ai', data.explanation);
      if (data.sql) {
        el.sql.value = data.sql;
        conversation.push({ role: 'assistant', content: data.raw || data.explanation });
        runQuery();
      }
    } catch (err) {
      addMessage('error', 'Failed to generate SQL: ' + err.message);
    } finally {
      setLoading(false);
    }
  }

  // ── Run Query ──
  async function runQuery() {
    const sql = el.sql.value.trim();
    if (!sql) return;

    setRunning(true);
    el.results.innerHTML = '<div class="ql-loading-row"><div class="ql-spinner"></div>Running query...</div>';
    el.rowCount.textContent = '';

    try {
      const data = await post(executeUrl, { sql });

      if (data.error) {
        el.results.innerHTML = '<div class="ql-error-box">' + esc(data.error) + '</div>';
        return;
      }

      renderResults(data);

      const summary = 'Query returned ' + data.row_count + ' row(s). Columns: ' + data.columns.join(', ') + '. First rows: ' + JSON.stringify(data.rows.slice(0, 5));
      const last = conversation[conversation.length - 1];
      if (last && last.role === 'assistant') last.content += '\n\nResult: ' + summary;
    } catch (err) {
      el.results.innerHTML = '<div class="ql-error-box">Failed to execute: ' + esc(err.message) + '</div>';
    } finally {
      setRunning(false);
    }
  }

  // ── Render Results ──
  function renderResults(data) {
    if (!data.columns || !data.columns.length) {
      el.results.innerHTML = '<div class="ql-results-empty"><span>Query returned no results</span></div>';
      el.rowCount.textContent = '';
      return;
    }

    let html = '';
    if (data.truncated) html += '<div class="ql-truncated">Results truncated to ' + data.row_count + ' rows</div>';

    html += '<table class="ql-table"><thead><tr>';
    data.columns.forEach(c => { html += '<th>' + esc(c) + '</th>'; });
    html += '</tr></thead><tbody>';

    data.rows.forEach(row => {
      html += '<tr>';
      row.forEach(cell => {
        if (cell === null) html += '<td><span class="ql-null">NULL</span></td>';
        else html += '<td>' + esc(String(cell)) + '</td>';
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    el.results.innerHTML = html;
    el.rowCount.textContent = data.row_count + ' row' + (data.row_count === 1 ? '' : 's') + (data.truncated ? ' (truncated)' : '');
  }

  // ── Messages ──
  function addMessage(role, content) {
    if (el.emptyState) { el.emptyState.remove(); }

    const wrap = document.createElement('div');
    const cls = role === 'user' ? 'ql-msg-user' : role === 'error' ? 'ql-msg-error' : 'ql-msg-ai';
    wrap.className = 'ql-msg ' + cls;

    const avatarLabel = role === 'user' ? 'You' : role === 'error' ? '!' : 'AI';
    wrap.innerHTML =
      '<div class="ql-msg-avatar">' + avatarLabel + '</div>' +
      '<div class="ql-msg-bubble">' + esc(content) + '</div>';

    // Remove typing indicator if present
    const typing = el.messages.querySelector('.ql-msg-typing');
    if (typing) typing.remove();

    el.messages.appendChild(wrap);
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  function showTyping() {
    if (el.emptyState) el.emptyState.remove();
    const wrap = document.createElement('div');
    wrap.className = 'ql-msg ql-msg-ai ql-msg-typing';
    wrap.innerHTML =
      '<div class="ql-msg-avatar">AI</div>' +
      '<div class="ql-msg-bubble"><div class="ql-typing"><span></span><span></span><span></span></div></div>';
    el.messages.appendChild(wrap);
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  // ── State ──
  function setLoading(on) {
    el.askBtn.disabled = on;
    el.input.disabled = on;
    if (on) {
      el.askBtn.innerHTML = '<div class="ql-spinner ql-spinner-sm"></div>';
      el.status.innerHTML = '<div class="ql-spinner ql-spinner-sm"></div>&nbsp;Generating SQL...';
      showTyping();
    } else {
      el.askBtn.textContent = 'Ask';
      el.status.textContent = '';
      el.input.focus();
    }
  }

  function setRunning(on) { el.runBtn.disabled = on; }

  // ── Helpers ──
  async function post(url, body) {
    const token = document.querySelector('meta[name="csrf-token"]')?.content;
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': token || '' },
      body: JSON.stringify(body)
    });
    return res.json();
  }

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
})();
</script>
