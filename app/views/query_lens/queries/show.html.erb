<div id="query-lens-app"
     data-execute-url="<%= query_lens.execute_path %>"
     data-generate-url="<%= query_lens.generate_path %>"
     data-info-url="<%= query_lens.info_path %>"
     data-projects-url="<%= query_lens.projects_path %>"
     data-saved-queries-url="<%= query_lens.saved_queries_path %>"
     data-conversations-url="<%= query_lens.conversations_path %>"
     class="ql-app">

  <!-- Header -->
  <header class="ql-header">
    <div class="ql-header-left">
      <h1 class="ql-logo">
        <span class="ql-logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
          </svg>
        </span>QueryLens
      </h1>
      <span class="ql-badge">AI-powered SQL</span>
    </div>
    <div class="ql-status" id="ql-status"></div>
  </header>

  <!-- Main -->
  <div class="ql-main">

    <!-- Chat Panel -->
    <div class="ql-chat">
      <div class="ql-tab-bar">
        <button class="ql-tab ql-tab-active" id="ql-tab-chat" type="button">Conversation</button>
        <button class="ql-tab" id="ql-tab-saved" type="button">Saved Queries</button>
      </div>

      <!-- Saved Queries Content (hidden by default) -->
      <div class="ql-saved-panel" id="ql-saved-panel" style="display:none;">
        <div class="ql-saved-toolbar">
          <button class="ql-saved-btn" id="ql-add-project-btn" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
            Project
          </button>
          <button class="ql-saved-btn ql-saved-btn-primary" id="ql-save-query-btn" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Save Query
          </button>
        </div>
        <div class="ql-saved-list" id="ql-saved-list"></div>
      </div>

      <!-- Conversation History -->
      <div class="ql-conversation-history" id="ql-conversation-history">
        <button class="ql-new-chat-btn" id="ql-new-chat-btn" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Chat
        </button>
        <div class="ql-conversation-list" id="ql-conversation-list"></div>
      </div>

      <!-- Chat Content -->
      <div class="ql-chat-content" id="ql-chat-content">
      <div class="ql-restricted-banner" id="ql-restricted-banner" style="display:none;">
        <button class="ql-restricted-toggle" id="ql-restricted-toggle" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <span id="ql-restricted-count"></span> restricted table(s)
          <svg class="ql-restricted-chevron" id="ql-restricted-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div class="ql-restricted-list" id="ql-restricted-list" style="display:none;"></div>
      </div>
      <div class="ql-messages" id="ql-messages">
        <div class="ql-empty-state" id="ql-empty-state">
          <div class="ql-empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
            </svg>
          </div>
          <div class="ql-empty-title">Ask about your data</div>
          <div class="ql-empty-text">
            Try something like:<br>
            "How many users signed up this month?"<br>
            "What's the total revenue by plan?"
          </div>
        </div>
      </div>
      </div><!-- /.ql-chat-content -->
      <div class="ql-input-area">
        <form class="ql-input-form" id="ql-form">
          <input type="text" id="ql-input" placeholder="Ask a question about your data..." autocomplete="off">
          <button type="submit" id="ql-ask-btn">Ask</button>
        </form>
      </div>
    </div>

    <!-- Workspace -->
    <div class="ql-workspace">

      <!-- SQL Editor -->
      <div class="ql-editor-section">
        <div class="ql-editor-toolbar">
          <div class="ql-editor-title">SQL Editor</div>
          <button class="ql-run-btn" id="ql-run-btn">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            Run
            <span class="ql-run-shortcut">&hairsp;&#8984;&#9166;&hairsp;</span>
          </button>
        </div>
        <div class="ql-editor-wrap">
          <textarea class="ql-sql-textarea" id="ql-sql" placeholder="-- Your SQL query will appear here..." spellcheck="false"></textarea>
        </div>
      </div>

      <!-- Results -->
      <div class="ql-results-section">
        <div class="ql-results-toolbar">
          <div class="ql-results-title">Results</div>
          <div class="ql-row-count" id="ql-row-count"></div>
        </div>
        <div class="ql-results-body" id="ql-results">
          <div class="ql-results-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 0v.375"/>
            </svg>
            <span>Run a query to see results</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const app = document.getElementById('query-lens-app');
  const executeUrl = app.dataset.executeUrl;
  const generateUrl = app.dataset.generateUrl;
  const infoUrl = app.dataset.infoUrl;
  const projectsUrl = app.dataset.projectsUrl;
  const savedQueriesUrl = app.dataset.savedQueriesUrl;
  const conversationsUrl = app.dataset.conversationsUrl;

  const el = {
    messages:  document.getElementById('ql-messages'),
    emptyState: document.getElementById('ql-empty-state'),
    input:     document.getElementById('ql-input'),
    form:      document.getElementById('ql-form'),
    askBtn:    document.getElementById('ql-ask-btn'),
    sql:       document.getElementById('ql-sql'),
    runBtn:    document.getElementById('ql-run-btn'),
    results:   document.getElementById('ql-results'),
    rowCount:  document.getElementById('ql-row-count'),
    status:    document.getElementById('ql-status'),
    restrictedBanner: document.getElementById('ql-restricted-banner'),
    restrictedToggle: document.getElementById('ql-restricted-toggle'),
    restrictedChevron: document.getElementById('ql-restricted-chevron'),
    restrictedCount: document.getElementById('ql-restricted-count'),
    restrictedList: document.getElementById('ql-restricted-list'),
    tabChat:    document.getElementById('ql-tab-chat'),
    tabSaved:   document.getElementById('ql-tab-saved'),
    chatContent: document.getElementById('ql-chat-content'),
    savedPanel:  document.getElementById('ql-saved-panel'),
    savedList:   document.getElementById('ql-saved-list'),
    addProjectBtn: document.getElementById('ql-add-project-btn'),
    saveQueryBtn:  document.getElementById('ql-save-query-btn'),
    conversationHistory: document.getElementById('ql-conversation-history'),
    newChatBtn:    document.getElementById('ql-new-chat-btn'),
    conversationList: document.getElementById('ql-conversation-list'),
  };

  let conversation = [];
  let currentConversationId = null;
  let conversationsList = [];

  // ── Load restricted tables ──
  (async function loadInfo() {
    try {
      const res = await fetch(infoUrl);
      const info = await res.json();
      if (info.excluded_tables && info.excluded_tables.length > 0) {
        el.restrictedCount.textContent = info.excluded_tables.length;
        el.restrictedList.innerHTML = info.excluded_tables
          .map(t => '<span class="ql-restricted-tag">' + esc(t) + '</span>')
          .join('');
        el.restrictedBanner.style.display = 'block';
      }
    } catch (e) { /* silently fail */ }
  })();

  el.restrictedToggle.addEventListener('click', () => {
    const open = el.restrictedList.style.display === 'none';
    el.restrictedList.style.display = open ? 'flex' : 'none';
    el.restrictedChevron.classList.toggle('ql-open', open);
  });

  // ── Events ──
  el.form.addEventListener('submit', (e) => { e.preventDefault(); ask(); });
  el.runBtn.addEventListener('click', () => runQuery());
  el.sql.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); runQuery(); }
    // Tab inserts spaces
    if (e.key === 'Tab') {
      e.preventDefault();
      const s = el.sql.selectionStart;
      el.sql.value = el.sql.value.substring(0, s) + '  ' + el.sql.value.substring(el.sql.selectionEnd);
      el.sql.selectionStart = el.sql.selectionEnd = s + 2;
    }
  });

  // ── Ask ──
  async function ask() {
    const q = el.input.value.trim();
    if (!q) return;

    el.input.value = '';
    const askTime = new Date();
    addMessage('user', q, askTime);
    conversation.push({ role: 'user', content: q });
    setLoading(true);

    const trace = [];
    trace.push({ time: askTime, dot: 'blue', label: 'Question received' });

    try {
      const data = await post(generateUrl, { messages: conversation });
      const genTime = new Date();

      if (data.error) {
        trace.push({ time: genTime, dot: 'red', label: 'Error: ' + data.error });
        addMessage('error', data.error);
        addTrace(trace);
        return;
      }

      // Build generation trace entry
      let genLabel = 'SQL generated';
      if (data.generation_ms) genLabel += ' <strong>(' + formatMs(data.generation_ms) + ')</strong>';
      trace.push({ time: genTime, dot: 'blue', label: genLabel });

      // Schema strategy trace
      if (data.strategy === 'two_stage') {
        let schemaLabel = 'Schema: <strong>' + data.tables_used + '</strong> tables selected from ' + data.total_tables;
        trace.push({ time: genTime, dot: 'amber', label: schemaLabel, tables: data.tables_selected });
      } else if (data.total_tables) {
        trace.push({ time: genTime, dot: 'amber', label: 'Schema: <strong>' + data.total_tables + '</strong> tables (full schema)' });
      }

      if (data.explanation) addMessage('ai', data.explanation, genTime);
      if (data.sql) {
        el.sql.value = data.sql;
        conversation.push({ role: 'assistant', content: data.raw || data.explanation });
        await runQueryWithTrace(trace);
      } else {
        addTrace(trace);
      }
    } catch (err) {
      trace.push({ time: new Date(), dot: 'red', label: 'Error: ' + err.message });
      addMessage('error', 'Failed to generate SQL: ' + err.message);
      addTrace(trace);
    } finally {
      setLoading(false);
      saveConversation();
    }
  }

  // ── Run Query (standalone, e.g. manual run button) ──
  async function runQuery() {
    const sql = el.sql.value.trim();
    if (!sql) return;

    const trace = [];
    trace.push({ time: new Date(), dot: 'blue', label: 'Manual query execution' });
    await runQueryWithTrace(trace);
  }

  // ── Run Query with trace ──
  async function runQueryWithTrace(trace) {
    const sql = el.sql.value.trim();
    if (!sql) return;

    setRunning(true);
    el.results.innerHTML = '<div class="ql-loading-row"><div class="ql-spinner"></div>Running query...</div>';
    el.rowCount.textContent = '';

    try {
      const data = await post(executeUrl, { sql });
      const execTime = new Date();

      if (data.error) {
        trace.push({ time: execTime, dot: 'red', label: 'Query blocked: ' + esc(data.error) });
        el.results.innerHTML = '<div class="ql-error-box">' + esc(data.error) + '</div>';
        addTrace(trace);
        return;
      }

      let execLabel = 'Query executed';
      if (data.execution_ms) execLabel += ' <strong>(' + formatMs(data.execution_ms) + ')</strong>';
      trace.push({ time: execTime, dot: 'green', label: execLabel });

      let resultLabel = '<strong>' + data.row_count + '</strong> row' + (data.row_count === 1 ? '' : 's') + ' returned';
      if (data.truncated) resultLabel += ' (truncated)';
      trace.push({ time: execTime, dot: 'green', label: resultLabel });

      renderResults(data);

      const summary = 'Query returned ' + data.row_count + ' row(s). Columns: ' + data.columns.join(', ') + '. First rows: ' + JSON.stringify(data.rows.slice(0, 5));
      const last = conversation[conversation.length - 1];
      if (last && last.role === 'assistant') last.content += '\n\nResult: ' + summary;

      addTrace(trace);
    } catch (err) {
      trace.push({ time: new Date(), dot: 'red', label: 'Error: ' + esc(err.message) });
      el.results.innerHTML = '<div class="ql-error-box">Failed to execute: ' + esc(err.message) + '</div>';
      addTrace(trace);
    } finally {
      setRunning(false);
    }
  }

  // ── Render Results ──
  function renderResults(data) {
    if (!data.columns || !data.columns.length) {
      el.results.innerHTML = '<div class="ql-results-empty"><span>Query returned no results</span></div>';
      el.rowCount.textContent = '';
      return;
    }

    let html = '';
    if (data.truncated) html += '<div class="ql-truncated">Results truncated to ' + data.row_count + ' rows</div>';

    html += '<table class="ql-table"><thead><tr>';
    data.columns.forEach(c => { html += '<th>' + esc(c) + '</th>'; });
    html += '</tr></thead><tbody>';

    data.rows.forEach(row => {
      html += '<tr>';
      row.forEach(cell => {
        if (cell === null) html += '<td><span class="ql-null">NULL</span></td>';
        else html += '<td>' + esc(String(cell)) + '</td>';
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    el.results.innerHTML = html;
    el.rowCount.textContent = data.row_count + ' row' + (data.row_count === 1 ? '' : 's') + (data.truncated ? ' (truncated)' : '');
  }

  // ── Messages ──
  function addMessage(role, content, timestamp) {
    if (el.emptyState) { el.emptyState.remove(); }

    const wrap = document.createElement('div');
    const cls = role === 'user' ? 'ql-msg-user' : role === 'error' ? 'ql-msg-error' : 'ql-msg-ai';
    wrap.className = 'ql-msg ' + cls;

    const avatarLabel = role === 'user' ? 'You' : role === 'error' ? '!' : 'AI';
    const timeStr = timestamp ? formatTime(timestamp) : '';
    wrap.innerHTML =
      '<div class="ql-msg-avatar">' + avatarLabel + '</div>' +
      '<div><div class="ql-msg-bubble">' + esc(content) + '</div>' +
      (timeStr ? '<div class="ql-msg-time">' + timeStr + '</div>' : '') +
      '</div>';

    // Remove typing indicator if present
    const typing = el.messages.querySelector('.ql-msg-typing');
    if (typing) typing.remove();

    el.messages.appendChild(wrap);
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  // ── Activity Trace ──
  function addTrace(steps) {
    if (!steps.length) return;

    const wrap = document.createElement('div');
    wrap.className = 'ql-trace';

    let html = '<div class="ql-trace-inner">';
    html += '<div class="ql-trace-header">';
    html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>';
    html += 'Activity trace</div>';

    steps.forEach(step => {
      html += '<div class="ql-trace-row">';
      html += '<span class="ql-trace-time">' + formatTime(step.time) + '</span>';
      html += '<span class="ql-trace-dot ql-trace-dot-' + step.dot + '"></span>';
      html += '<span class="ql-trace-label">' + step.label + '</span>';
      html += '</div>';
      if (step.tables && step.tables.length) {
        html += '<div class="ql-trace-row"><span class="ql-trace-time"></span><span class="ql-trace-dot" style="visibility:hidden"></span>';
        html += '<span class="ql-trace-tables">';
        step.tables.forEach(t => { html += '<span class="ql-trace-table-tag">' + esc(t) + '</span>'; });
        html += '</span></div>';
      }
    });

    html += '</div>';
    wrap.innerHTML = html;
    el.messages.appendChild(wrap);
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  function showTyping() {
    if (el.emptyState) el.emptyState.remove();
    const wrap = document.createElement('div');
    wrap.className = 'ql-msg ql-msg-ai ql-msg-typing';
    wrap.innerHTML =
      '<div class="ql-msg-avatar">AI</div>' +
      '<div class="ql-msg-bubble"><div class="ql-typing"><span></span><span></span><span></span></div></div>';
    el.messages.appendChild(wrap);
    el.messages.scrollTop = el.messages.scrollHeight;
  }

  // ── State ──
  function setLoading(on) {
    el.askBtn.disabled = on;
    el.input.disabled = on;
    if (on) {
      el.askBtn.innerHTML = '<div class="ql-spinner ql-spinner-sm"></div>';
      el.status.innerHTML = '<div class="ql-spinner ql-spinner-sm"></div>&nbsp;Generating SQL...';
      showTyping();
    } else {
      el.askBtn.textContent = 'Ask';
      el.status.textContent = '';
      el.input.focus();
    }
  }

  function setRunning(on) { el.runBtn.disabled = on; }

  // ── Helpers ──
  async function request(url, method, body) {
    const token = document.querySelector('meta[name="csrf-token"]')?.content;
    const opts = {
      method: method || 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': token || '' }
    };
    if (body !== undefined) opts.body = JSON.stringify(body);
    const res = await fetch(url, opts);
    if (res.status === 204) return null;
    return res.json();
  }

  async function post(url, body) { return request(url, 'POST', body); }

  function formatTime(date) {
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
  }

  function formatMs(ms) {
    if (ms < 1000) return ms + 'ms';
    return (ms / 1000).toFixed(1) + 's';
  }

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  // ── Conversation Persistence ──
  async function loadConversations() {
    try {
      const data = await request(conversationsUrl, 'GET');
      conversationsList = data;
      renderConversationList();
    } catch (e) { /* silently fail */ }
  }

  function renderConversationList() {
    if (!conversationsList.length) {
      el.conversationList.innerHTML = '';
      return;
    }

    let html = '<div class="ql-conversation-divider">Recent</div>';
    conversationsList.forEach(c => {
      const active = c.id === currentConversationId ? ' ql-conversation-item-active' : '';
      html += '<div class="ql-conversation-item' + active + '" data-conversation-id="' + c.id + '">';
      html += '<span class="ql-conversation-title">' + esc(c.title) + '</span>';
      html += '<span class="ql-conversation-time">' + timeAgo(c.updated_at) + '</span>';
      html += '<button class="ql-conversation-delete" data-delete-id="' + c.id + '" type="button">&times;</button>';
      html += '</div>';
    });

    el.conversationList.innerHTML = html;

    // Bind click events
    el.conversationList.querySelectorAll('.ql-conversation-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (e.target.closest('.ql-conversation-delete')) return;
        loadConversation(parseInt(item.dataset.conversationId, 10));
      });
    });

    el.conversationList.querySelectorAll('.ql-conversation-delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = parseInt(btn.dataset.deleteId, 10);
        try {
          await request(conversationsUrl + '/' + id, 'DELETE');
          if (currentConversationId === id) startNewChat();
          loadConversations();
        } catch (e) { /* silently fail */ }
      });
    });
  }

  async function loadConversation(id) {
    try {
      const data = await request(conversationsUrl + '/' + id, 'GET');
      currentConversationId = data.id;
      conversation = data.messages || [];

      // Clear and re-render messages
      el.messages.innerHTML = '';
      if (!conversation.length) {
        el.messages.innerHTML = '<div class="ql-empty-state" id="ql-empty-state"><div class="ql-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg></div><div class="ql-empty-title">Ask about your data</div><div class="ql-empty-text">Try something like:<br>"How many users signed up this month?"<br>"What\'s the total revenue by plan?"</div></div>';
      } else {
        conversation.forEach(msg => {
          addMessage(msg.role === 'assistant' ? 'ai' : msg.role, msg.content);
        });
      }

      // Restore SQL editor
      el.sql.value = data.last_sql || '';

      // Clear results
      el.results.innerHTML = '<div class="ql-results-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 0v.375"/></svg><span>Run a query to see results</span></div>';
      el.rowCount.textContent = '';

      renderConversationList();
    } catch (e) { /* silently fail */ }
  }

  function startNewChat() {
    currentConversationId = null;
    conversation = [];
    el.messages.innerHTML = '<div class="ql-empty-state" id="ql-empty-state"><div class="ql-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg></div><div class="ql-empty-title">Ask about your data</div><div class="ql-empty-text">Try something like:<br>"How many users signed up this month?"<br>"What\'s the total revenue by plan?"</div></div>';
    el.sql.value = '';
    el.results.innerHTML = '<div class="ql-results-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 0v.375"/></svg><span>Run a query to see results</span></div>';
    el.rowCount.textContent = '';
    el.input.focus();
    renderConversationList();
  }

  async function saveConversation() {
    try {
      const lastSql = el.sql.value.trim() || null;
      if (currentConversationId) {
        await request(conversationsUrl + '/' + currentConversationId, 'PATCH', {
          messages: conversation,
          last_sql: lastSql
        });
      } else {
        const firstUserMsg = conversation.find(m => m.role === 'user');
        const title = firstUserMsg ? firstUserMsg.content.substring(0, 80) : 'New conversation';
        const data = await request(conversationsUrl, 'POST', {
          title: title,
          messages: conversation,
          last_sql: lastSql
        });
        if (data && data.id) currentConversationId = data.id;
      }
      loadConversations();
    } catch (e) { /* fire-and-forget */ }
  }

  function timeAgo(dateStr) {
    const now = new Date();
    const date = new Date(dateStr);
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h';
    const days = Math.floor(hours / 24);
    return days + 'd';
  }

  el.newChatBtn.addEventListener('click', startNewChat);
  loadConversations();

  // ── Tab Switching ──
  function switchTab(tab) {
    if (tab === 'saved') {
      el.tabSaved.classList.add('ql-tab-active');
      el.tabChat.classList.remove('ql-tab-active');
      el.savedPanel.style.display = 'flex';
      el.chatContent.style.display = 'none';
      el.conversationHistory.style.display = 'none';
      loadSavedQueries();
    } else {
      el.tabChat.classList.add('ql-tab-active');
      el.tabSaved.classList.remove('ql-tab-active');
      el.chatContent.style.display = 'flex';
      el.savedPanel.style.display = 'none';
      el.conversationHistory.style.display = 'block';
    }
  }

  el.tabChat.addEventListener('click', () => switchTab('chat'));
  el.tabSaved.addEventListener('click', () => switchTab('saved'));

  // ── Saved Queries ──
  let savedData = { projects: [], unorganized: [] };
  let collapsedProjects = {};

  async function loadSavedQueries() {
    try {
      const data = await request(projectsUrl, 'GET');
      savedData = data;
      renderSavedList();
    } catch (e) { /* silently fail */ }
  }

  function renderSavedList() {
    let html = '';

    savedData.projects.forEach(project => {
      const collapsed = collapsedProjects[project.id];
      html += '<div class="ql-saved-project">';
      html += '<div class="ql-saved-project-header" data-project-id="' + project.id + '">';
      html += '<svg class="ql-saved-chevron' + (collapsed ? '' : ' ql-open') + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
      html += '<svg class="ql-saved-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>';
      html += '<span class="ql-saved-project-name">' + esc(project.name) + '</span>';
      html += '<span class="ql-saved-count">' + project.saved_queries.length + '</span>';
      html += '<button class="ql-kebab" data-menu="project-' + project.id + '" type="button">&#8942;</button>';
      html += '</div>';

      // Kebab menu
      html += '<div class="ql-kebab-menu" id="menu-project-' + project.id + '" style="display:none;">';
      html += '<button data-action="rename-project" data-id="' + project.id + '" data-name="' + esc(project.name) + '">Rename</button>';
      html += '<button data-action="delete-project" data-id="' + project.id + '">Delete</button>';
      html += '</div>';

      if (!collapsed) {
        project.saved_queries.forEach(q => {
          html += renderQueryItem(q);
        });
      }
      html += '</div>';
    });

    if (savedData.unorganized.length > 0) {
      html += '<div class="ql-saved-project">';
      html += '<div class="ql-saved-project-header ql-saved-unorg">';
      html += '<svg class="ql-saved-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>';
      html += '<span class="ql-saved-project-name">Unorganized</span>';
      html += '<span class="ql-saved-count">' + savedData.unorganized.length + '</span>';
      html += '</div>';
      savedData.unorganized.forEach(q => {
        html += renderQueryItem(q);
      });
      html += '</div>';
    }

    if (savedData.projects.length === 0 && savedData.unorganized.length === 0) {
      html = '<div class="ql-saved-empty">No saved queries yet. Run a query and click "Save Query" to get started.</div>';
    }

    el.savedList.innerHTML = html;
    bindSavedListEvents();
  }

  function renderQueryItem(q) {
    let html = '<div class="ql-saved-query" data-query-id="' + q.id + '" data-sql="' + esc(q.sql).replace(/"/g, '&quot;') + '">';
    html += '<svg class="ql-saved-query-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>';
    html += '<div class="ql-saved-query-info"><div class="ql-saved-query-name">' + esc(q.name) + '</div>';
    if (q.description) html += '<div class="ql-saved-query-desc">' + esc(q.description) + '</div>';
    html += '</div>';
    html += '<button class="ql-kebab" data-menu="query-' + q.id + '" type="button">&#8942;</button>';
    html += '</div>';

    html += '<div class="ql-kebab-menu" id="menu-query-' + q.id + '" style="display:none;">';
    html += '<button data-action="edit-query" data-id="' + q.id + '">Edit</button>';
    html += '<button data-action="move-query" data-id="' + q.id + '">Move</button>';
    html += '<button data-action="delete-query" data-id="' + q.id + '">Delete</button>';
    html += '</div>';

    return html;
  }

  function bindSavedListEvents() {
    // Project collapse/expand
    el.savedList.querySelectorAll('.ql-saved-project-header[data-project-id]').forEach(header => {
      header.addEventListener('click', (e) => {
        if (e.target.closest('.ql-kebab')) return;
        const id = header.dataset.projectId;
        collapsedProjects[id] = !collapsedProjects[id];
        renderSavedList();
      });
    });

    // Load query on click
    el.savedList.querySelectorAll('.ql-saved-query').forEach(item => {
      item.addEventListener('click', (e) => {
        if (e.target.closest('.ql-kebab')) return;
        const sql = item.dataset.sql;
        el.sql.value = sql;
        switchTab('chat');
        runQuery();
      });
    });

    // Kebab toggles
    el.savedList.querySelectorAll('.ql-kebab').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menuId = 'menu-' + btn.dataset.menu;
        const menu = document.getElementById(menuId);
        // Close all other menus
        el.savedList.querySelectorAll('.ql-kebab-menu').forEach(m => { if (m.id !== menuId) m.style.display = 'none'; });
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
      });
    });

    // Menu actions
    el.savedList.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        // Close menu
        btn.closest('.ql-kebab-menu').style.display = 'none';

        if (action === 'rename-project') renameProject(id, btn.dataset.name);
        else if (action === 'delete-project') deleteProject(id);
        else if (action === 'edit-query') editQuery(id);
        else if (action === 'move-query') moveQuery(id);
        else if (action === 'delete-query') deleteQuery(id);
      });
    });
  }

  // Close kebab menus on outside click
  document.addEventListener('click', () => {
    document.querySelectorAll('.ql-kebab-menu').forEach(m => m.style.display = 'none');
  });

  // ── Project CRUD ──
  el.addProjectBtn.addEventListener('click', async () => {
    const name = prompt('Project name:');
    if (!name || !name.trim()) return;
    try {
      await request(projectsUrl, 'POST', { name: name.trim() });
      loadSavedQueries();
    } catch (e) { alert('Failed to create project'); }
  });

  async function renameProject(id, currentName) {
    const name = prompt('Rename project:', currentName);
    if (!name || !name.trim() || name.trim() === currentName) return;
    try {
      await request(projectsUrl + '/' + id, 'PATCH', { name: name.trim() });
      loadSavedQueries();
    } catch (e) { alert('Failed to rename project'); }
  }

  async function deleteProject(id) {
    if (!confirm('Delete this project? Queries will be moved to Unorganized.')) return;
    try {
      await request(projectsUrl + '/' + id, 'DELETE');
      loadSavedQueries();
    } catch (e) { alert('Failed to delete project'); }
  }

  // ── Save Query ──
  el.saveQueryBtn.addEventListener('click', () => {
    const sql = el.sql.value.trim();
    if (!sql) { alert('No SQL in the editor to save.'); return; }
    showSaveModal(sql);
  });

  function showSaveModal(sql, existing) {
    // Remove any existing modal
    const old = document.getElementById('ql-save-modal');
    if (old) old.remove();

    const isEdit = !!existing;
    const modal = document.createElement('div');
    modal.id = 'ql-save-modal';
    modal.className = 'ql-modal-overlay';

    let projectOptions = '<option value="">(None)</option>';
    savedData.projects.forEach(p => {
      const sel = (existing && existing.project_id === p.id) ? ' selected' : '';
      projectOptions += '<option value="' + p.id + '"' + sel + '>' + esc(p.name) + '</option>';
    });

    modal.innerHTML =
      '<div class="ql-modal">' +
      '<div class="ql-modal-title">' + (isEdit ? 'Edit Saved Query' : 'Save Current Query') + '</div>' +
      '<label class="ql-modal-label">Name</label>' +
      '<input class="ql-modal-input" id="ql-save-name" value="' + (existing ? esc(existing.name) : '') + '" placeholder="e.g. Monthly revenue">' +
      '<label class="ql-modal-label">Description <span style="color:#52525b">(optional)</span></label>' +
      '<input class="ql-modal-input" id="ql-save-desc" value="' + (existing ? esc(existing.description || '') : '') + '" placeholder="What does this query do?">' +
      '<label class="ql-modal-label">Project</label>' +
      '<select class="ql-modal-input" id="ql-save-project">' + projectOptions + '</select>' +
      '<div class="ql-modal-actions">' +
      '<button class="ql-modal-btn ql-modal-btn-cancel" id="ql-save-cancel">Cancel</button>' +
      '<button class="ql-modal-btn ql-modal-btn-save" id="ql-save-confirm">' + (isEdit ? 'Update' : 'Save') + '</button>' +
      '</div></div>';

    document.body.appendChild(modal);

    document.getElementById('ql-save-name').focus();

    document.getElementById('ql-save-cancel').addEventListener('click', () => modal.remove());
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });

    document.getElementById('ql-save-confirm').addEventListener('click', async () => {
      const name = document.getElementById('ql-save-name').value.trim();
      if (!name) { alert('Name is required'); return; }
      const desc = document.getElementById('ql-save-desc').value.trim();
      const projectId = document.getElementById('ql-save-project').value || null;

      const payload = { name: name, description: desc, sql: sql, project_id: projectId };

      try {
        if (isEdit) {
          await request(savedQueriesUrl + '/' + existing.id, 'PATCH', payload);
        } else {
          await request(savedQueriesUrl, 'POST', payload);
        }
        modal.remove();
        loadSavedQueries();
      } catch (e) { alert('Failed to save query'); }
    });
  }

  // ── Edit Query ──
  function editQuery(id) {
    const q = findQuery(id);
    if (!q) return;
    showSaveModal(q.sql, q);
  }

  // ── Move Query ──
  async function moveQuery(id) {
    const q = findQuery(id);
    if (!q) return;
    let choices = 'Move to project:\n0 - (None / Unorganized)';
    savedData.projects.forEach((p, i) => { choices += '\n' + (i + 1) + ' - ' + p.name; });
    const choice = prompt(choices);
    if (choice === null) return;
    const idx = parseInt(choice, 10);
    const projectId = idx === 0 ? null : (savedData.projects[idx - 1] ? savedData.projects[idx - 1].id : null);
    try {
      await request(savedQueriesUrl + '/' + id, 'PATCH', { project_id: projectId });
      loadSavedQueries();
    } catch (e) { alert('Failed to move query'); }
  }

  // ── Delete Query ──
  async function deleteQuery(id) {
    if (!confirm('Delete this saved query?')) return;
    try {
      await request(savedQueriesUrl + '/' + id, 'DELETE');
      loadSavedQueries();
    } catch (e) { alert('Failed to delete query'); }
  }

  function findQuery(id) {
    id = parseInt(id, 10);
    for (const p of savedData.projects) {
      const q = p.saved_queries.find(q => q.id === id);
      if (q) return q;
    }
    return savedData.unorganized.find(q => q.id === id);
  }
})();
</script>
