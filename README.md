# QueryLens

A mountable Rails engine that lets users write natural language questions and get SQL queries generated by Claude AI, executed against their database, with results displayed â€” all in one interface. Think "Blazer meets ChatGPT."

## Features

- Natural language to SQL conversion powered by Claude
- Automatic database schema introspection
- Interactive conversation with context (follow-up questions refine queries)
- Read-only query execution (safety enforced at transaction level)
- Editable SQL editor with syntax highlighting
- Results displayed as sortable tables
- Configurable authentication, timeouts, and row limits
- Zero frontend build step (Tailwind via CDN, vanilla JS)

## Installation

Add to your Gemfile:

```ruby
gem "query_lens"
```

Then run:

```bash
bundle install
rails generate query_lens:install
```

This will:
1. Create `config/initializers/query_lens.rb`
2. Add the engine route to your `config/routes.rb`

## Configuration

Set your Anthropic API key:

```bash
export ANTHROPIC_API_KEY=sk-ant-...
```

Edit `config/initializers/query_lens.rb`:

```ruby
QueryLens.configure do |config|
  # Required
  config.anthropic_api_key = ENV["ANTHROPIC_API_KEY"]

  # Optional
  config.model = "claude-sonnet-4-5-20250929"     # Claude model
  config.max_rows = 1000                           # Max rows returned
  config.query_timeout = 30                        # Seconds
  config.excluded_tables = %w[api_keys secrets]    # Hide from AI
  config.authentication = ->(controller) {         # Auth check
    controller.current_user&.admin?
  }
end
```

## Usage

Visit `/query_lens` in your browser and start asking questions:

- "How many users signed up this month?"
- "What's the total revenue by plan?"
- "Show me the top 10 accounts by transaction volume"
- "Break that down by month" (follow-up questions work!)

## Security

QueryLens enforces multiple layers of safety:

1. **Read-only transactions**: All queries run inside `SET TRANSACTION READ ONLY` (PostgreSQL)
2. **SQL parsing**: Rejects any statement that isn't a SELECT
3. **Statement blocklist**: Blocks INSERT, UPDATE, DELETE, DROP, ALTER, CREATE, TRUNCATE, GRANT, REVOKE
4. **Row limits**: Configurable max rows (default 1000)
5. **Authentication**: Configurable auth lambda to restrict access
6. **Schema filtering**: Exclude sensitive tables from AI context

**Important**: Always restrict access to QueryLens in production using the `authentication` config option. Even with read-only enforcement, database access should be limited to authorized users.

## Requirements

- Rails 7.1+
- Ruby 3.1+
- An Anthropic API key
- PostgreSQL recommended (SQLite works but without `SET TRANSACTION READ ONLY`)

## Development

```bash
git clone https://github.com/bryanbeshore/query_lens.git
cd query_lens
bundle install
bundle exec rake test
```

## Contributing

1. Fork the repo
2. Create your feature branch (`git checkout -b my-feature`)
3. Commit your changes (`git commit -am 'Add feature'`)
4. Push to the branch (`git push origin my-feature`)
5. Create a Pull Request

## License

MIT License. See [MIT-LICENSE](MIT-LICENSE).
